# Bitcoin

比特币：一个点对点电子现金系统，中本聪，2008

比特币是一种电子货币；一个可以防止重复支付（double-spending）的公开总账系统；一种去中心化的可信机制。

##概述

**为什么我们需要电子货币**

* 方便在线支付，因为没有能够直接进行美元支付的系统
* 信用卡运行的很好，但也存在一些问题，如不安全、信用卡欺诈、需要手续费、有诸多限制、交易可逆等。而且信用卡记录了使用者的所有购买行为。

**电子货币技术上需要解决的问题**

* 伪造
* 重复支付（double spending）
* 盗窃

**社会和经济上需要解决的问题**

* 为什么电子货币有价值
* 如何为基础设施支付？
* 货币政策（比如有意的通货膨胀）
* 法律（税务、洗钱、毒品、恐怖主义）

##比特币交易细节

**使用电子签名的交易序列**

这是比特币中的一部分，交易中包含很多coin，每枚都属于某个人。每个coin都有一系列的交易记录。每次交易中，这枚coin会被支付给其他人，coin的最近交易会标明其拥有者。

**交易记录的内容**

* pub(Un) coin新主人的公钥
* hash(Tp) coin上一个交易记录的哈希值
* sig(Up) 上一个主人使用其私钥对交易记录签名的结果
* 比特币更复杂：交易数据中的amount有分数，有多个in和out

**交易示例**

```
 Y拥有一枚货币，是之前的交易中X给他的:
    T7: pub(Y), hash(T6), sig(X)
  Y从Z那购买了一个汉堡，向他支付这枚coin
    Z 将公钥发送给Y
    Y 创建一个新交易，使用自己的私钥对交易信息签名
    T8: pub(Z), hash(T7), sig(Y)
  Y 将交易信息发给 Z
  Z 进行校验:
    T8的sig()与T7的pub()[Y的公钥] 相对应,使用此公钥即可解密
  Z 收到coin，把汉堡发给 Y
```

Z的余额是Z私钥对应的未花费交易，coin的id是其最近交易的哈希值。Z拥有coin的私钥，因此允许Z做下一次交易。其他人不能花费这枚coin，因为下次交易时需要拥有者的私钥。但攻击者可以偷得Z的私钥，比如从电脑或智能手机中偷取。

**coin的主人是否能够重复支付？**

Y可以使用一枚coin创建两个交易：Y->Z和Y->Q，都是hash(T7)
Y分别向Z和Q同时展示了两个不同交易，这两个交易看起来都正确，都包含签名和哈希，现在Z和Q都会给Y汉堡。

重复支付是可能的，这是因为Z和Q不知道交易的完整集合。

**交易顺序**

我们需要确保每个节点的全部交易的顺序都保持一致。例如，Y->Z和Y->Q同时发生时，公开账本中的所有节点接受的交易顺序是一致的。 

为什么不依赖花旗和美联储确保顺序？因为我们要去中心啊，否则中心伪造了记录没人知道。

比特币中数以千计的节点，可以被任何人运行，在对等网络中不需要任何任何一个单点；节点创建交易后需要广播新交易；交易Y->Z只在大多数节点校验通过后才被接受，多数校验能够确保重复支付被检测到。
但怎样确定多数？怎么计算节点？可能通过唯一的IP地址？
IP地址不安全，这很容易伪造。攻击者可以模拟一万台机器作为多数。当Z询问时，攻击者的多数回应“我们只知道Y->Z”，Q询问时，攻击者的多数回应“我们只知道Y->Q”，攻击的可能性催生很多P2P方案。

##比特币的区块链

区块链包含所有coin的交易记录。每个节点都有一个完整的区块链副本，所有交易和块都会被广播到所有节点。
每个块包含的内容：
    前一个块的哈希、交易集合、nonce、当前时间戳
只有区块链中的交易才是真的，每10分钟产生一个新区块，其包含上一个区块的哈希值


**谁创造新区块**

这就是“挖矿”了。
挖出一个区块需要做的是：节点不断尝试nonce的值，直到hash(区块)生成的值以N个0开头。
尝试一个nonce很快，但多数nonce都不能达到目的，就像翻转很多双面硬币直到全部出现正面，每次翻转都有一个独立的成功机会。挖到一个区块不是一个有固定的具体数量的工作，这需要大约花费CPU一个月的时间才能创建一个区块。但成百上千的节点一起工作，这个时间会被缩短到10分钟，成功找到nonce的节点会将新区块发给其他所有节点。


**区块链中Y->Z交易是如何工作的**

开始时，所有节点都知道区块链【...<-B5】，正在尝试添加B6（寻找适当的nonces）。
Y发送Y->Z交易到每个节点，节点缓存该交易直到B6完成，节点会在下个区块中添加Y->Z交易，最终生成的区块链是【...<-B5<-B6<-B7】，其中B7中包含Y->Z

如果Y想要进行“重复支付”，同时发送Y->Z和Y->Q时会发生什么？可能使用网络拒绝服务（Dos）来阻止不断发包，也可能使用分支B6<-BZ 和 B6<-BQ。


**如何处理分支**

每个节点初始时将首先看到的（不管是BZ还是BQ）认为是初始记录，尝试创建一个后续区块。
若更多节点看到的是BZ，将会在BZ的基础上继续挖矿，使得BZ看起来是首先创建的。
若刚好是对半分，添加后续区块时肯定会在这两个区块其中之一的后面。因此，某一个分支会首先得到一个后续区块，会变得更长。
节点通常在最长的分支上挖矿。

因此，临时的“重复支付”（double-spending）会造成分支，但其中的一个分支最后会消失，因为另外一个会变得更长。
如果Z看到Y->Z的后面有一些区块，此时Y->Q很难能够追的上Y-Z(因为工作量证明)。
如果Z正在出售高价值的产品，他应该等待Y-Z这个区块后有多个后续区块后才交付产品。
如果Z正在出售一些便宜的产品，那么可以等到其他节点看到Y-Z之后就能够交付产品。

##防止攻击者

**攻击者是否能够在区块链中间修改记录？**

没那么简单，因为后续的区块持有真实前序区块的哈希值。

**攻击者是否可以从一个旧区块开启一个分支，使用Y-Q代替Y->Z?**

是的，但是分支必须要比区块链当前分支的长度更长。所以，如果攻击者修改的区块后有N个区块，他必须在新的分支后生成N+M+1个区块（M是主分支在fork点之后的区块数量）。
这就要求攻击者必须比其他节点挖矿挖的更快，如果攻击者只有一个CPU，制造这些block可能需要好几个月，在此期间，主链会变得更长，没有节点会切换到攻击者这个短分支挖矿。所以攻击者没有任何机会进行破坏。
如果攻击者有1000个CPU，比守规则的节点还多，那么攻击者可以创建成功创建一个fork并改变区块链，也可以进行“重复支付”。

**总结**

如果攻击者控制了大多数的CPU计算力，可以强制使“诚实”的节点从真实链切换到攻击者自己创建的链上。


##校验检查

节点对于新交易需要校验：

* 没有其他交易花掉相同的前序交易的钱
* 通过前一个交易的私钥校验电子签名，将交易添加正在挖掘的区块的交易列表

节点对于新区块需要校验：

* 哈希值有足够的0序列（即nonce是正确的，证明其工作）
* 上一个区块哈希值存在
* 新链比当前链长
* 区块中的所有交易都是正确的
    
对应收款方Z来说，需要校验：
    
* Y->Z 在一个区块
* Z的公钥/地址在交易中
* 区块链中的该块后有很多区块
    
**每个比特币初始从何而来？**

每次一个节点挖出一个区块，他会得到25个比特币（当前是25块），节点将其公钥放在区块中一个特殊的交易中，这是对人民挖矿的奖励

Q:如果很多矿工加入，是否会挖的更快？
不会，有工作量控制
Q：10分钟挖出一个区块很让人心烦，能不能快点？
不能..
Q：交易是否匿名？
可以匿名，每个地址只用于单笔交易
Q：如果我偷了比特币，可以安全的花掉吗？
Q：比特币是否可以伪造，如完全伪造比特币的制造？
Q：如果有世界上大多数的CPU计算力后,可以做哪些事情？
   可以重复支付
   不能偷其他人的比特币
   可以阻止整个链中的交易
   可以撤销过去交易（通过在该块之前创建更长的链）

Q:如果一个节点被欺骗，被其他坏节点合谋欺骗怎么办？
Q：一个崭新的节点加入后，是否会使用错误的链？几年之后重新加入会怎么样？
Q：如果更多的CPU挖矿，区块的产生速度是否会更快？
    哈希target控制

Q：一台机器挖矿，你能赚多少钱？
Q：怎么理解挖矿的收益随着时间而减少？
    比特币代码写的每挖210,000个区块后收益减半
Q：比特币的数量是固定的，这会带来什么问题？
    要跟真实世界一样增长？
Q：为什么比特币有价值？
    BTC目前每个$456
Q：什么会影响比特币交易规模？
    比特币交易率，CPU限制了4千tps（校验签名），比visa多，但比现金低
    区块链长度会影响吗？你一直需要查看很老的块吗？一直需要传输整个区块吗？默克尔树：区块头和交易数据
    
Q：比特币只是一个总账而不是一个新货币？
    
##要点：区块链
    
* 公开账本是一个好主意
* 去中心化可能很好
* 挖矿是一个好方法，可以避免攻击
* 把总账系成链看起来很笨，但可能是必要的
